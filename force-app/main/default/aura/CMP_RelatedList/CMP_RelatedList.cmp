<!-- 
 * File Name    : CMP_RelatedList
 * Author       : sy.lee
 * Date         : 2024-04-03
 * Description  :  
 * Copyright (c) 2023. LG CNS, All Rights Reserved.
 * Modification Log
 * ===============================================================
 * Ver      Date           Author              Modification
 * ===============================================================
   1.0      2024-04-03     sy.lee              Create
   2.0      2024-06-21     sy.lee              Refactoring
                      
-->
<!--suppress InconsistentSalesforceApiVersion -->
<aura:component description="CMP_RelatedList" controller="CMP_RelatedListController" extends="c:CMP_RelatedListHelper"
                implements="force:appHostable,flexipage:availableForAllPageTypes,forceCommunity:availableForAllPageTypes,force:hasRecordId,force:lightningQuickActionWithoutHeader">

    <!-- Attributes ============================ -->
    <aura:attribute name="isLoading" type="Boolean" description="loading" default="true"/>
    <aura:attribute name="result" type="Object" access="public" description="현재 대상 개체"/>

    <!-- Required Information -->
    <!-- 공통  ======================================================================================================================================================================================================== -->
    <aura:attribute name="currentObjectApi" type="String" access="public" description="현재 대상 개체"/>
    <aura:attribute name="currentObjectFields" type="String" access="public" description="추가적으로 쿼리가 필요한 필드"/>
    <aura:attribute name="relatedListId" type="String" access="public" description="관련 목록 유니크 Id"/>

    <!-- 1번째 Related List  ========================================================================================================================================================================================== -->
    <aura:attribute name="targetObjectApi" type="String" access="public" description="조회 대상 개체"/>
    <aura:attribute name="fields" type="String" access="public" description="조회 대상 필드 (콤마로 구분)"/>
    <aura:attribute name="condition" type="String" access="public" description="WHERE 조건"/>
    <aura:attribute name="sortedBy" type="String" access="public" description="정렬 필드"/>
    <aura:attribute name="sortedDirection" type="String" access="public" description="정렬 방식(asc / desc)"/>
    <aura:attribute name="limitCount" type="String" access="public" description="레코드 조회 개수"/>
    <aura:attribute name="isWithOutSharing" type="Boolean" access="public" description="without sharing 적용"/>
    <aura:attribute name="needAccessCheck" type="Boolean" access="public" description="현재 대상 개체"/>

    <!-- Header -->
    <aura:attribute name="iconName" type="String" access="public" description="아이콘 이름"/>
    <aura:attribute name="title" type="String" access="public" description="제목 (커스텀 라벨의 경우 Label.xxx 사용) - 없는 경우는 개체의 라벨 사용"/>
    <aura:attribute name="useStandardNew" type="Boolean" access="public" default="false" description="표준 New 기능 사용"/>
    <aura:attribute name="buttonComponentName" type="String" access="public" description="동적으로 생성할 버튼 컴포넌트 이름"/>
    <aura:attribute name="useExport" type="Boolean" access="public" description="Excel 다운로드 사용 여부" />

    <!-- Table -->
    <aura:attribute name="hideCheckboxColumn" type="Boolean" access="public" default="false" description="체크박스 표시 여부"/>
    <aura:attribute name="maxRowSelection" type="String" access="public" description="선택 가능한 Row 개수"/>
    <aura:attribute name="showRowNumberColumn" type="Boolean" access="public" description="현재 대상 개체"/>

    <aura:attribute name="applyApprovalLock" type="Boolean" access="public"
                    description="현재 대상 개체의 Approval Lock 여부에 따라 버튼 및 row action 활성화 유무 설정"/>

    <aura:attribute name="useEditRowAction" type="Boolean" access="public" default="true"
                    description="Edit Row Action 사용 여부"/>
    <aura:attribute name="useShowDetailRowAction" type="Boolean" access="public" default="true"
                    description="Show Detail Row Action 사용 여부"/>
    <aura:attribute name="useDeleteRowAction" type="Boolean" access="public" default="true"
                    description="Delete Row Action 사용 여부"/>
    <aura:attribute name="columns" type="List" access="public" description="테이블의 컬럼"/>
    <aura:attribute name="applyRefresh" type="Boolean" access="public" description="force:refreshView 적용"/>
    <aura:attribute name="sortedByMap" type="Object" access="public" default="true" description="정렬된 필드 라벨을 위한 맵"/>
    <aura:attribute name="query" type="String" access="public" description="쿼리"/>

    <!-- Internal Use -->
    <aura:attribute name="recordCount" type="String" access="public" default="(0)" description="전체 레코드 카운트"/>
    <aura:attribute name="itemCount" type="String" access="public" description="현재 레코드 카운트"/>
    <aura:attribute name="sortedByLabel" type="String" access="public" description="정렬 필드 라벨"/>
    <aura:attribute name="buttons" type="Aura.Component[]" access="public" description="동적으로 생성된 버튼"/>
    <aura:attribute name="data" type="List" access="public" description="테이블의 데이터"/>
    <aura:attribute name="countQuery" type="String" access="public" description="카운트 쿼리"/>

    <!-- View All -->
    <aura:attribute name="useStandardViewAll" type="Boolean" access="public" description="표준 View All 기능 사용"/>
    <aura:attribute name="relationShipName" type="String" access="public" description="현재 대상 개체"/>
    <!--    <aura:attribute name="relationField" type="String" access="public" description="관계 필드(표준 New 기능 사용시 기입 - 부모 레코드 아이디를 넣기 위함)"/>-->
    <aura:attribute name="isInfinityLoading" type="Boolean" access="public" description="Custom View All - Infinity Loading 적용"/>

    <!-- Mobile -->
    <aura:attribute name="isPhone" type="Boolean" description="폼팩터"/>
    <aura:attribute name="mobileTest" type="Boolean" description="모바일 테스트하는 경우 설정" default="false"/>

    <!-- LMS 수신 -->
    <lightning:messageChannel type="CMP_RelatedListMessageChannel__c" onMessage="{!c.fnSubscribeMessage}"/>

    <!-- Import =============================== -->
    <aura:import library="lightning:confirm" property="LightningConfirm" />

    <!-- Handler =============================== -->
    <ltng:require
            scripts="{!join(',', (v.useExport ? $Resource.CMP_SheetJs : ''), (v.useExport ? $Resource.CMP_FileSaver : ''), $Resource.CMP_RelatedListDummy)}"
            afterScriptsLoaded="{!c.fnInit}" />

    <!-- Component ================================= -->
    <lightning:overlayLibrary aura:id="overlayLib"/>
    <lightning:navigation aura:id="navService"/>

    <!-- 2024.06.21 - sy.lee - 처음에 값이 없으므로 모바일이라는 확실한 값이 들어가기전에 데스크탑 UI가 표시되는 경우가 있다. 값이 있는지 없는지도 판단해야 한다 -->
    <aura:if isTrue="{!empty(v.isPhone)}">
        <div class="slds-is-relative">
            <lightning:spinner alternativeText="Loading" variant="brand"/>
        </div>
        <aura:set attribute="else">
            <!-- Mobile ====================================================================================================================================================================================== -->
            <aura:if isTrue="{!v.isPhone}">
                <div onclick="{!c.fnClickRelatedList}">
                    <lightning:layout>
                        <lightning:layoutItem size="12" padding="around-small" class="white">
                            <div>
                                <div style="float: left">
                                    <!-- Icon -->
                                    <lightning:icon iconName="{#v.iconName}" size="small"/>
                                    <!-- Title -->
                                    <span class="slds-p-around_small slds-text-heading_small">
                                        {!v.title}&nbsp;{!v.recordCount}
                                    </span>
                                </div>
                                <!-- Right Icon -->
                                <div style="float: right">
                                    <lightning:icon iconName="utility:chevronright" size="x-small"/>
                                </div>
                            </div>
                        </lightning:layoutItem>
                    </lightning:layout>
                </div>
                <!-- Desktop and Tablet ====================================================================================================================================================================================== -->
                <aura:set attribute="else">
                    <article aura:id="main" class="main slds-card radius slds-box_border" style="border: var(--lwc-borderWidthThin,1px) solid var(--slds-g-color-border-base-1, var(--lwc-colorBorder,rgb(229, 229, 229)));">
                        <div class="front">
                            <div class="slds-card__header radius slds-grid" style="padding-left: 12px;padding-right: 12px;padding-top: 8px;padding-bottom: unset;">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <!-- Icon -->
                                    <div class="slds-media__figure noMarginLeft">
                                        <lightning:icon iconName="{#v.iconName}" size="small"></lightning:icon>
                                    </div>
                                    <!-- Title -->
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">
                                            <a style="color:unset;" onclick="{!c.fnViewAll}">{!v.title}&nbsp;{!v.recordCount}</a>
                                        </h2>
                                    </div>
                                    <!-- Button -->
                                    <div class="slds-no-flex slds-page-header__controls">
                                        <!-- List View Controls -->
                                        <lightning:buttonMenu alternativeText="Show menu" variant="border-filled" iconName="utility:settings" menuAlignment="right" onselect="{!c.fnClickMenu}" tooltip="{!$Label.c.CMP_CR_Lab_ListViewControls}">
                                            <lightning:menuSubheader label="{!$Label.c.CMP_CR_Lab_ListViewControls}"/>
                                            <lightning:menuItem value="ResetColumnWidth" label="{!$Label.c.CMP_CR_Btn_ResetColumnWidths}" />
                                        </lightning:buttonMenu>
                                        &nbsp;&nbsp;
                                        <!-- Refresh -->
                                        <lightning:buttonIcon iconName="utility:refresh" alternativeText="refresh" class="white" onclick="{!c.fnRefresh}" tooltip="{!$Label.c.CMP_CR_Btn_Refresh}"></lightning:buttonIcon>

                                        <!-- todo : 표준 New를 붙이는게 맞나? -->
                                        <!--<aura:if isTrue="{#v.useStandardNew}">
                                            <lightning:button label="New" onclick="{!c.fnStandardNew}" disabled="{!v.isLoading}" />
                                        </aura:if>-->

                                        <aura:if isTrue="{!v.useExport}">
                                            <lightning:button label="Export" onclick="{!c.fnExport}"></lightning:button>
                                        </aura:if>

                                        <aura:if isTrue="{!!v.result.currentObject.isLocked}">
                                            &nbsp;
                                            {!v.buttons}
                                        </aura:if>
                                    </div>
                                </header>
                            </div>

                            <!-- Description -->
                            <div class="slds-card__header slds-grid description" style="padding-left: 12px;padding-right: 12px;">
                                <aura:if isTrue="{!v.data.length > 0}">
                                    {!v.itemCount} • {!v.sortedByLabel}
                                </aura:if>
                            </div>

                            <!-- Body -->
                            <div class="slds-card__body slds-card__body_inner slds-p-around_none slds-is-relative">
                                <aura:if isTrue="{!v.isLoading}">
                                    <lightning:spinner alternativeText="Loading" variant="brand"/>
                                </aura:if>

                                <aura:if isTrue="{!v.data.length > 0}">
                                    <c:cmp_Table aura:id="table" keyField="Id" class="slds-scrollable_x"
                                                 data="{!v.data}"
                                                 columns="{!v.columns}"
                                                 hideCheckboxColumn="{#!v.hideCheckboxColumn}"
                                                 showRowNumberColumn="{#v.showRowNumberColumn}"
                                                 columnWidthsMode="auto"
                                                 maxColumnWidth="4000"
                                                 minColumnWidth="120"
                                                 defaultSortDirection="asc"
                                                 sortedBy="{!v.sortedBy}"
                                                 sortedDirection="{!v.sortedDirection}"
                                                 onsort="{!c.fnSort}"
                                                 onrowaction="{!c.fnRowAction}">
                                    </c:cmp_Table>
                                </aura:if>
                            </div>
                            <!-- Footer -->
                            <aura:if isTrue="{!v.data.length > 0}">
                                <a onclick="{!c.fnViewAll}">
                                    <footer class="slds-card__footer noTopBorder">
                                        {!$Label.c.CMP_CR_Btn_ViewAll}
                                    </footer>
                                </a>
                            </aura:if>
                        </div>
                    </article>
                </aura:set>
            </aura:if>
        </aura:set>
    </aura:if>


</aura:component>